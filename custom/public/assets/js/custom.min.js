/* eslint-disable @eslint-community/eslint-comments/disable-enable-pair */
/* eslint-disable unicorn/prefer-add-event-listener */
/* eslint-disable github/no-dataset */
class SimpleDB {
  constructor(storeName = 'items', ttl = 3600, dbName = 'gitea') {
    this.dbName = dbName;
    this.storeName = storeName;
    this.ttl = ttl; // seconds
    this.db = null;
  }

  async _openDB(version) {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.dbName, version);

      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          db.createObjectStore(this.storeName, {keyPath: 'key'});
        }
      };

      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async init() {
    if (this.db) return this.db;

    // 先開一次拿 version
    let version = 1;
    try {
      const tmp = await this._openDB();
      version = tmp.version;
      const hasStore = tmp.objectStoreNames.contains(this.storeName);
      tmp.close();
      if (!hasStore) version += 1;
    } catch {
      // 第一次建立 DB
    }

    this.db = await this._openDB(version);
    return this.db;
  }

  _isExpired(item) {
    if (!this.ttl) return false;
    return ((Date.now() / 1000) - item.createdAt) > this.ttl;
  }

  async get(key) {
    const db = await this.init();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);
      const req = store.get(key);

      req.onsuccess = () => {
        const item = req.result;
        if (!item) return resolve(null);

        if (this._isExpired(item)) {
          store.delete(key);
          resolve(null);
        } else {
          resolve(item.value);
        }
      };

      req.onerror = () => reject(req.error);
    });
  }

  async set(key, value) {
    const db = await this.init();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);

      const req = store.put({
        key,
        value,
        createdAt: Date.now() / 1000,
      });

      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  }

  async remove(key) {
    const db = await this.init();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);
      const req = store.delete(key);

      req.onsuccess = () => resolve(true);
      req.onerror = () => reject(req.error);
    });
  }

  async clear() {
    const db = await this.init();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);
      const req = store.clear();

      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  async getAllKeys() {
    const db = await this.init();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.storeName, 'readwrite');
      const store = tx.objectStore(this.storeName);
      const req = store.getAllKeys();

      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
}

function setCursor(cursor) {
  document.body.style.cursor = cursor;
  for (const el of document.querySelectorAll('textarea')) {
    el.style.cursor = cursor;
  }
  for (const el of document.querySelectorAll('input')) {
    el.style.cursor = cursor;
  }
}

/**
 * Scroll to top or bottom of the page.
 */
// eslint-disable-next-line @typescript-eslint/no-unused-vars
function goTo(position, e) {
  window.scrollTo({
    top: position === 'bottom' ? document.body.scrollHeight : 0,
    behavior: 'smooth',
  });
  e.currentTarget.classList.add('tw-hidden');
}

function controlButtonsVisibility() {
  if (document.body.scrollHeight <= window.innerHeight) return;
  const observer = new IntersectionObserver((entries) => {
    for (const entry of entries) {
      if (entry.target.id === 'navbar' && entry.isIntersecting) {
        document.querySelector('.gotocontrol.up').classList.add('tw-hidden');
        document.querySelector('.gotocontrol.down').classList.remove('tw-hidden');
      } else if (entry.target.id === '' && entry.isIntersecting) {
        document.querySelector('.gotocontrol.down').classList.add('tw-hidden');
        document.querySelector('.gotocontrol.up').classList.remove('tw-hidden');
      } else {
        if (window.scrollY > 0) document.querySelector('.gotocontrol.up').classList.remove('tw-hidden');
        document.querySelector('.gotocontrol.down')?.classList.remove('tw-hidden');
      }
    }
  }, {
    root: null,
    threshold: 0,
  });

  observer.observe(document.querySelector('#navbar'));
  observer.observe(document.querySelector('.page-footer'));
}

function post(url, data) {
  // eslint-disable-next-line no-restricted-syntax
  return fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Csrf-Token': window.config.csrfToken,
    },
    body: new URLSearchParams(data).toString(),
  });
}

async function get(url) {
  setCursor('wait');
  // eslint-disable-next-line no-restricted-syntax
  const response = await fetch(url, {
    headers: {
      'X-Csrf-Token': window.config.csrfToken,
    },
  });
  setCursor('');
  return response.ok ? response.json() : null;
}

/**
 * Assign users to an issue.
 */
function hiToAssignee(userNames) {
  const assigneeInput = document.querySelector('input[name="assignee_ids"]');
  if (!assigneeInput) return;
  window.assigneeElement = assigneeInput.closest('div');
  const availableUserElements = Array.from(window.assigneeElement.querySelectorAll('.dropdown a.item span.gt-ellipsis'), (el) => el.closest('a.item'));
  const isNewIssue = document.querySelector('#issue_title');
  window.assigneeIds = window.assigneeIds || [];

  for (const availableUserElement of availableUserElements) {
    const isChecked = userNames.includes(availableUserElement.querySelector('.gt-ellipsis').title);
    const assigneeData = {action: 'attach', id: availableUserElement.dataset.value};
    const checked = availableUserElement.classList.contains('checked');
    if (isNewIssue && checked !== isChecked) {
      window.assigneeElement = window.assigneeElement.querySelector('.dropdown');
      availableUserElement.click();
    } else if (checked !== isChecked && !window.assigneeIds.some((el) => el.action === assigneeData.action && el.id === assigneeData.id)) {
      window.assigneeIds.push(assigneeData);
    }
  }
}

// auto select label #9
const _autoLabels = {
  'Solved': /^([Ff]ix|[Cc]ommit|[Mm]erge)([\w/ ]{4,}r\d{2,} [\da-f]{7,})/,
  'Test/OK': /[Tt]est [Oo][Kk]\n/,
  'Test/NG': /[Tt]est ([Ff]ail|[Nn][Gg])\n/,
  'TestOK': /[Tt]est [Oo][Kk]\n/,
  'TestNG': /[Tt]est ([Ff]ail|[Nn][Gg])\n/,
  'NotTest': /[Nn]ot? [Tt]est\n/,
  'Tested': /[Tt]ested\n/,
};
const _titleLables = {
  'F2': ['f2 verify', 'f2 verification'],
  'Verification': ['verify', 'verification'],
  'ReleaseNote': ['release note'],
  'Wish': ['hope', 'wish'],
  'ADM': ['總務課'],
  'EWC': ['福委會'],
};

async function autoLabels(content) {
  const labelInput = document.querySelector('input[name=label_ids]');
  if (!labelInput) return;
  window.labelElement = labelInput.closest('div');
  const availableLabelElements = Array.from(window.labelElement.querySelectorAll('.menu a.item:not(.checked)'));
  const titleInputElement = document.querySelector('#issue_title');

  window.labelIds = window.labelIds || [];
  for (const [label, pattern] of Object.entries(_autoLabels)) {
    if (pattern.test(content)) {
      const contentLabelElement = availableLabelElements.find((el) => el.textContent.includes(label));
      if (contentLabelElement) {
        if (titleInputElement) window.labelElement = window.labelElement.querySelector('.dropdown');
        const lableData = {action: 'attach', id: contentLabelElement.dataset.value};
        if (!window.labelIds.some((el) => el.action === lableData.action && el.id === lableData.id)) window.labelIds.push(lableData);
        break;
      }
    }
  }

  if (titleInputElement) {
    const titleLabelMatch = Object.keys(_titleLables).find((key) => _titleLables[key].some((k) => titleInputElement.value.toLowerCase().includes(k)));
    if (titleLabelMatch) {
      const titleLabelElement = availableLabelElements.find((el) => el.textContent.includes(titleLabelMatch));
      if (titleLabelElement) {
        window.labelElement = window.labelElement.querySelector('.dropdown');
        titleLabelElement.click();
      }
    }
    const deptLabelElement = availableLabelElements.find((el) => el.textContent.includes(window.dept));
    if (deptLabelElement) {
      window.labelElement = window.labelElement.querySelector('.dropdown');
      deptLabelElement.click();
    }
    const nowYear = new Date().getFullYear().toString();
    const milestoneYearElement = Array.from(document.querySelector('input[name=milestone_id]').closest('div').querySelectorAll('.menu a.item')).find((el) => el.textContent.trim() === nowYear);
    if (milestoneYearElement) milestoneYearElement.click();
  }
}

/**
 * Auto-save drafts for markdown editors using localStorage.
 */
function autoSaveDraft() {
  // Auto-save drafts for markdown editors
  for (const textarea of document.querySelectorAll('textarea')) {
    const form = textarea.closest('form');
    if (!form) break;
    const isEasyMDE = localStorage.getItem('markdown-editor-comment') === 'easymde';

    const storageKey = textarea.id.replace(/^_combo_markdown_editor_/, '');
    const defaultContent = textarea.value.trim();
    const draft = localStorage.getItem(storageKey);
    if (draft) {
      if (isEasyMDE) {
        textarea._giteaComboMarkdownEditor?.easyMDE?.codemirror.setValue(draft);
      } else {
        textarea.value = draft;
      }
    }

    const doSave = () => {
      const content = textarea.value.trim();
      if (content.length && content !== defaultContent) {
        localStorage.setItem(storageKey, textarea.value);
      }

      if (content.length) {
        autoLabels(content);
        const isNewIssue = document.querySelector('#issue_title');
        if (isNewIssue) {
          window.labelElement.click();
        }

        const firstLine = content.split('\n')[0].trim();
        if (firstLine.startsWith('Hi @') && !firstLine.endsWith(',')) {
          hiToAssignee(firstLine.slice(4).split(' ').map((u) => u.trim().replace(/^@/, '')));
          if (isNewIssue) {
            window.assigneeElement.click();
          }
        }
      } else {
        localStorage.removeItem(storageKey);
      }
    };

    if (isEasyMDE) {
      textarea.closest('form').querySelector('.CodeMirror-lines')?.addEventListener('mouseleave', doSave);
    } else {
      textarea.addEventListener('mouseleave', doSave);
    }

    form.addEventListener('submit', async () => {
      if (textarea.value.trim() === defaultContent) textarea.value = '';
      localStorage.setItem('last-submitted-draft', storageKey);
      if (window.labelIds) {
        for (const lableData of window.labelIds) {
          await post(window.labelElement.dataset.updateUrl, lableData);
        }
      }
      if (window.assigneeIds) {
        for (const assigneeData of window.assigneeIds) {
          await post(window.assigneeElement.dataset.updateUrl, assigneeData);
        }
      }
    });
  }

  const lastSubmittedDraft = localStorage.getItem('last-submitted-draft');
  if (lastSubmittedDraft) {
    localStorage.removeItem(lastSubmittedDraft);
    localStorage.removeItem('last-submitted-draft');
  }
}

/**
 * Automatically react with "eyes" emoji when a comment comes into view.
 * This uses IntersectionObserver to detect when comment headers are fully visible.
 * It waits 3 seconds before adding the reaction to avoid accidental reactions.
 * It also checks if the reaction already exists to prevent duplicates.
 * @see https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API
 */
function eyesHandler() {
  const commentList = document.querySelector('.comment-list');
  if (!commentList) return;
  const observer = new IntersectionObserver((entries) => {
    for (const entry of entries) {
      if (entry.isIntersecting) {
        observer.unobserve(entry.target);
        const eyes = entry.target.querySelector('a.emoji[data-tooltip-content="eyes"]');
        if (eyes) {
          const existEyesReaction = entry.target.querySelector(`.bottom-reactions a[data-reaction-content=eyes][title*="${window.userTitle}"]`);
          if (existEyesReaction?.title.split(',').map((s) => s.trim()).includes(window.userTitle)) {
            return;
          }
          setTimeout(() => {
            post(`${entry.target.querySelector('.select-reaction').dataset.actionUrl}/react`, {content: 'eyes'});
          }, 3000);
        }
      }
    }
  }, {
    root: null,
    rootMargin: '-20% 0px',
    threshold: 1,
  });

  const commentHeaders = commentList.querySelectorAll('.comment-container');
  for (const header of commentHeaders) {
    observer.observe(header);
  }
}

/**
 * Wait for the markdown editor to be ready.
 */
function waitForTextareaToBeReady() {
  let attemptCount = 0;
  const MAX_ATTEMPTS = 30;
  const INTERVAL_MS = 100;

  const intervalId = setInterval(() => {
    const markdownEditor = document.querySelector('textarea')?._giteaComboMarkdownEditor;
    attemptCount++;

    if (markdownEditor) {
      clearInterval(intervalId);
      autoSaveDraft(); // Hi assignee, auto-labels
      eyesHandler();
    } else if (attemptCount >= MAX_ATTEMPTS) {
      clearInterval(intervalId);
    }
  }, INTERVAL_MS);
}

function watchAnnouncementsRepos() {
  const announcementPath = '/ADM/ANN';
  const isAnnouncementPage = window.location.pathname.startsWith(announcementPath);

  if (isAnnouncementPage) {
    const unwatchFormButtonElement = document.querySelector(`form[action="${announcementPath}/action/unwatch"] button`);
    const watchFormButtonElement = document.querySelector(`form[action="${announcementPath}/action/watch"] button`);

    if (unwatchFormButtonElement) {
      unwatchFormButtonElement.disabled = true;
    }

    if (watchFormButtonElement) {
      watchFormButtonElement.click();
    }
  }
}

function addCommentCounter() {
  const commentLists = document.querySelectorAll('.comment-list .comment-header-left');
  if (!commentLists) return;

  for (const [index, commentHeader] of commentLists.entries()) {
    if (index === 0) continue; // Skip the first comment (issue description)
    const counterSpan = document.createElement('span');
    counterSpan.className = 'comment-counter';
    counterSpan.textContent = `#${index} `;
    commentHeader.prepend(counterSpan);
  }
}

function relationPRtoIssuesTitle() {
  if (!document.querySelector('.pullrequest-form')) return;
  const comparePos = location.pathname.indexOf('/compare/');
  if (comparePos === -1) return;
  const reposName = location.pathname.substring(1, comparePos);
  if (!reposName) return;
  const branchNameWithID = location.pathname.substring(location.pathname.indexOf('...') + 3, location.pathname.length).replace(/%23/g, '#');
  const branchNameAndRepoAndIDMatch = /^(\w+)_.*_([\w/-]+)[_#](\d+)$/.exec(branchNameWithID);
  const branchNameAndIDMatch = /^(\w+)_.*[_#](\d+)$/.exec(branchNameWithID);
  const issueRepoAndIDMatch = /_([\w/-]+)[_#](\d+)$/.exec(branchNameWithID);
  const issueIDOnlyMatch = /[_#](\d+)$/.exec(branchNameWithID);
  const issueTitleInput = document.querySelector('#issue_title');
  const markdownEditor = document.querySelector('.markdown-text-editor');

  const fetchIssueDetails = async (mergeReposName, mergeIssueID) => {
    const issueData = await get(`/api/v1/repos/${mergeReposName}/issues/${mergeIssueID}`);
    if (!issueData) return;
    const gid = reposName === mergeReposName ? `#${mergeIssueID}` : `${mergeReposName}#${mergeIssueID}`;
    issueTitleInput.value = `${issueData.title} ${gid}`;
    markdownEditor.value = markdownEditor.value.replace(/Issue ID:/, `Issue ID: ${gid}`);
    const commitSummary = Array.from(document.querySelectorAll('.commit-summary'), (v) => v.textContent).reverse();
    markdownEditor.value = markdownEditor.value.replace(/Description:\n -/, `Description:\n- ${commitSummary.join('\n - ')}`);
    const labelInput = document.querySelector('input[name=label_ids]');
    const labelElement = labelInput.closest('div');
    for (const label of issueData.labels.map((v) => [v.id, v.name])) {
      if (!['bug', 'important'].includes(label[1].toLowerCase())) continue;
      labelElement.querySelector(`a[data-value="${label[0]}"]`).click();
    }
  };

  function selectedBranchName(branchName) {
    const branchWithoutRepo = location.pathname.substring(location.pathname.indexOf('/compare/') + 9);
    if (!branchWithoutRepo.startsWith(branchName)) {
      const matchBranch = Array.from(document.querySelectorAll('.base-branch-list a')).find((el) => el.textContent.endsWith(branchName));
      if (matchBranch) {
        const threeDotPos = branchWithoutRepo.indexOf('...');
        location = new URL(location.href.replace(branchWithoutRepo.substring(0, threeDotPos), branchName));
      }
    }
  }

  if (branchNameAndRepoAndIDMatch?.length > 3) {
    selectedBranchName(branchNameAndRepoAndIDMatch[2]);
    fetchIssueDetails(branchNameAndRepoAndIDMatch[2], branchNameAndRepoAndIDMatch[3]);
  } else if (branchNameAndIDMatch?.length > 2) {
    selectedBranchName(branchNameAndIDMatch[1]);
    fetchIssueDetails(reposName, branchNameAndIDMatch[2]);
  } else if (issueRepoAndIDMatch?.length > 2) {
    fetchIssueDetails(issueRepoAndIDMatch[1], issueRepoAndIDMatch[2]);
  } else if (issueIDOnlyMatch?.length > 1) {
    fetchIssueDetails(reposName, issueIDOnlyMatch[1]);
  }
}

const loadResource = (url, callback) => {
  if (document.querySelector(`script[src="${url}"]`) || document.querySelector(`link[href="${url}"]`)) {
    return;
  }
  const type = url.endsWith('.css') ? 'css' : 'js';
  const element = document.createElement(type === 'css' ? 'link' : 'script');
  if (type === 'css') {
    element.rel = 'stylesheet';
    element.href = url;
  } else {
    element.src = url;
    element.defer = true;
  }

  element.addEventListener('load', () => {
    // eslint-disable-next-line @typescript-eslint/no-unused-expressions
    callback && callback();
  });

  if (type === 'css') {
    document.head.append(element);
  } else {
    document.body.append(element);
  }
};

function reportGenerator() {
  document.querySelector('.page-content').classList.add('tw-hidden');
  document.querySelector('#report').classList.remove('tw-hidden');

  loadResource('https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css');

  loadResource('https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js', () => {
    const {createApp} = window.Vue;

    function daysBefore(n) {
      const date = new Date();
      date.setDate(date.getDate() - n);
      return date.toISOString().slice(0, 10);
    }

    window.app = createApp({
      delimiters: ['[[', ']]'],
      data() {
        return {
          orig: '',
          startDate: daysBefore(7),
          endDate: daysBefore(0),
          endDateMax: daysBefore(0),
          by: window.isRD ? 'assigned_by' : 'created_by',
          type: 'all',
          state: 'all',
          labels: '',
          q: '',
          username: window.loginedUser,
          assignees: [],
        };
      },
      watch: {
        startDate(newValue) {
          const newDay = new Date(newValue);
          newDay.setDate(newDay.getDate() + 7);
          if (newDay > new Date(this.endDate)) return;
          this.endDate = newDay.toISOString().slice(0, 10);
        },
        endDate(newValue) {
          const newDay = new Date(newValue);
          if (new Date(this.startDate) < newDay) return;
          newDay.setDate(newDay.getDate() - 7);
          this.startDate = newDay.toISOString().slice(0, 10);
        },
      },
      methods: {
        async queryReport() {
          const params = new URLSearchParams();
          params.set('state', this.state);
          params.set('since', `${this.startDate}T00:00:00Z`);
          params.set('before', `${this.endDate}T23:59:59Z`);
          params.set('limit', 1000);

          if (this.orig) params.set('owner', this.orig);
          if (this.labels) params.set('labels', this.labels);
          if (this.q) params.set('q', this.q);

          const db = new SimpleDB('reportissue', this.endDate < daysBefore(0) ? 0 : 3600);
          if (window.firstreport) {
            window.firstreport = false;
            const keys = await db.getAllKeys();
            const today = new Date().toISOString().slice(0, 10);
            const keysToDelete = keys.filter((key) => key.includes(today));
            for (const key of keysToDelete) {
              await db.remove(key);
            }
          }
          let resData = await db.get(params.toString());

          if (!resData) {
            resData = await get(`/api/v1/repos/issues/search?${params.toString()}`);
            db.set(params.toString(), resData);
          }
          const data = [];
          const assigneeLists = [];
          let i = 1;
          for (const issue of resData) {
            if (this.by === 'assigned_by' && issue.assignees) {
              for (const assignee of issue.assignees) {
                assigneeLists.push({username: assignee.username, avatar_url: assignee.avatar_url});
              }
            } else if (this.by === 'created_by') {
              assigneeLists.push({username: issue.user.username, avatar_url: issue.user.avatar_url});
            }
            if ((this.username.length && (this.by === 'assigned_by' && !issue.assignees?.some((a) => a.username === this.username)) ||
              (this.username.length && this.by === 'created_by' && issue.user.username !== this.username) ||
              (this.username.length && this.by === 'mentioned_by' && !issue.body.includes(`@${this.username}`))) ||
              (this.type !== 'all' && this.type !== (issue.pull_request ? 'pr' : 'issue')) ||
              (this.state !== 'all' && this.state !== issue.state)) {
              continue;
            }

            const labels = issue.labels.map((l) => l.name);
            const labelColors = issue.labels.map((l) => l.color);
            let label = '';
            for (let j = 0; j < labels.length; j++) {
              // eslint-disable-next-line github/unescaped-html-literal
              label += `<span style="background-color:#${labelColors[j]}">${labels[j]}</span> `;
            }

            const checkedTasks = issue.body.match(/- \[x\] /g)?.length || 0;
            const totalTasks = checkedTasks + (issue.body.match(/- \[ \] /g)?.length || 0);
            const pct = totalTasks > 0 ? Math.round(checkedTasks / totalTasks * 100) : 0;

            // eslint-disable-next-line github/unescaped-html-literal
            const title = `<a href="${issue.html_url}" target="_blank" rel="noopener">${issue.title}</a>`;

            // eslint-disable-next-line no-undef
            data.push([`${i++}.`, issue.pull_request ? 'PR' : 'Issue', issue.user.username, issue.assignees?.map((a) => a.username).join(', '), `${issue.repository.full_name}#${issue.number}`, gridjs.html(title), gridjs.html(label), issue.state, issue.created_at.slice(0, 19).replace('T', ' '), issue.updated_at.slice(0, 19).replace('T', ' '), `${pct}%`, issue.due_date ? issue.due_date.slice(0, 10) : '']);
          }
          this.assignees = Array.from(new Map(assigneeLists.map((a) => [a.username, a])).values()).sort((a, b) => a.username.localeCompare(b.username));

          window.grid.updateConfig({
            data,
          }).forceRender();

          const exportBtn = document.createElement('input');
          exportBtn.type = 'button';
          exportBtn.value = 'Export';
          exportBtn.className = 'gridjs-input';
          document.querySelector('.gridjs-search').append(exportBtn);
          exportBtn.addEventListener('click', () => {
            // eslint-disable-next-line no-undef
            const tableExport = new TableExport(document.querySelector('.gridjs-table'), {formats: ['csv'], filename: `report-${this.endDate}`});
            const exportData = tableExport.getExportData('csv')['tableexport-1']['csv'];
            tableExport.export2file(exportData.data,
              exportData.mimeType,
              exportData.filename,
              exportData.fileExtension,
              exportData.merges,
              exportData.RTL,
              exportData.sheetname);
          });
        },
        selectAssignee(assignee) {
          this.username = assignee;
        },
      },
      mounted() {
        loadResource('https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js', async () => {
          const columns = [
            {name: 'No.', attributes: {style: 'width: 60px'}},
            {name: 'Type', hidden: true, attributes: {style: 'white-space:nowrap;overflow:hidden'}},
            {name: 'Creator', hidden: true, attributes: {style: 'white-space:nowrap;overflow:hidden'}},
            {name: 'Assignee', hidden: true, attributes: {style: 'white-space:nowrap;overflow:hidden'}},
            {name: 'Repos.#ID', attributes: {style: 'width:auto;white-space:nowrap'}},
            {name: 'Title', attributes: {style: 'width:auto'}},
            {name: 'Labels', hidden: true, attributes: {style: 'white-space:nowrap;overflow:hidden'}},
            {name: 'Status', hidden: true, attributes: {style: 'width:80px'}},
            {name: 'Created At', hidden: true, attributes: {style: 'width:auto;white-space:nowrap;overflow:hidden'}},
            {name: 'Updated At', hidden: true, attributes: {style: 'width:auto;white-space:nowrap;overflow:hidden'}},
            {name: 'PCT', hidden: true, attributes: {style: 'width:70px;white-space:nowrap'}},
            {name: 'Due Date', hidden: true, attributes: {style: 'width:auto;white-space:nowrap;overflow:hidden'}},
          ];

          // eslint-disable-next-line no-undef
          window.grid = new gridjs.Grid({
            columns,
            data: [],
            sort: true,
            search: true,
          }).render(document.querySelector('#wrapper'));
          window.firstreport = true;
          window.app.queryReport();

          for (const column of columns) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `toggle-column-${column.name}`;
            checkbox.checked = !column.hidden;
            checkbox.addEventListener('change', (event) => {
              column.hidden = !event.target.checked;
              window.grid.updateConfig({
                columns,
              }).forceRender();
            });

            const label = document.createElement('label');
            label.htmlFor = `toggle-column-${column.name}`;
            label.innerHTML = ` ${column.name}&nbsp;&nbsp;`;

            const container = document.querySelector('#column-controls');
            container.append(checkbox);
            container.append(label);
            container.append(document.createTextNode(' '));
          }
        });
      },
    }).mount('#report');
    window.Vue = null;
  });
  loadResource('https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js');
  loadResource('https://cdn.jsdelivr.net/npm/tableexport/dist/js/tableexport.min.js');
}

function addReleaseFilterBar() {
  const newReleases = document.querySelector('.new.release form:not(.secondary-nav form)');
  if (newReleases) {
    newReleases.addEventListener('submit', async () => {
      const db = new SimpleDB('releases');
      await db.remove(location.pathname.replace(/\/new$/, ''));
    });
    return;
  }
  const wrapper = document.querySelector('#release-list');
  if (!wrapper) return;
  const filterBar = document.querySelector('#releaseFilterBar');
  filterBar.classList.remove('tw-hidden');
  wrapper.insertBefore(filterBar, wrapper.children[0]);
  loadResource('https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js', () => {
    const {createApp} = window.Vue;
    createApp({
      delimiters: ['[[', ']]'],
      data() {
        return {
          releaselists: [],
        };
      },
      methods: {
        async queryRelease() {
          const db = new SimpleDB('releases');
          let data = await db.get(location.pathname);
          if (!data) {
            const reposName = location.pathname.substring(1, location.pathname.indexOf('/releases'));
            data = await get(`/api/v1/repos/${reposName}/releases`);
            db.set(location.pathname, data);
          }
          this.releaselists = data.map((v) => {return {name: v.name, html_url: v.html_url}});
          document.querySelector('#releaseFilterBar .filter').classList.add('visible');
        },
        selectRelease(html_url) {
          location = new URL(html_url);
        },
      },
    }).mount('#releaseFilterBar');
    window.Vue = null;
  });
}

function addPageControlBarToTop() {
  const pageControlElement = document.querySelector('.page');
  if (pageControlElement) {
    const issueListElement = document.querySelector('#issue-list') || document.querySelector('#activity-feed');
    if (issueListElement) {
      const newCloseButton = document.createElement('a');
      newCloseButton.className = 'close-btn';
      newCloseButton.addEventListener('click', () => {
        document.querySelector('.top-pagination').remove();
        localStorage.removeItem('top-pagination');
      });
      const topControlElement = pageControlElement.cloneNode(true);
      topControlElement.classList.add('top-pagination');
      topControlElement.querySelector('.menu').append(newCloseButton);
      issueListElement.parentNode.insertBefore(topControlElement, issueListElement);
      localStorage.setItem('top-pagination', 'true');
    }
  }
}

function addPageControlButton() {
  if (localStorage.getItem('top-pagination') === 'true') {
    addPageControlBarToTop();
    return;
  }

  const pageControlElement = document.querySelector('.page');
  if (pageControlElement) {
    const topControlButton = document.createElement('a');
    topControlButton.className = 'top-control-button';
    topControlButton.textContent = 'Add Page Bar to Top';
    topControlButton.addEventListener('click', () => {
      if (document.querySelector('.top-pagination')) return;
      addPageControlBarToTop();
      topControlButton.classList.add('tw-hidden');
    });
    const wrapper = document.createElement('div');
    wrapper.className = 'center tw-mt-4';
    wrapper.append(topControlButton);
    pageControlElement.parentNode.appendChild(wrapper, pageControlElement);
  }
}

function addViewLogsButton() {
  const first = document.querySelector('.first');
  if (!first) return;
  const events = document.querySelectorAll('.event');
  if (!events) return;
  for (const el of events) el.classList.toggle('tw-hidden');

  const viewLogButton = document.createElement('button');
  viewLogButton.className = 'ui button tw-mt-1 tw-ml-1';
  viewLogButton.style.minHeight = 'unset';
  viewLogButton.textContent = `Logs (${events.length})`;
  viewLogButton.addEventListener('click', () => {
    for (const el of events) el.classList.toggle('tw-hidden');
  });
  first.append(viewLogButton);
}

function addRelatedButton() {
  const first = document.querySelector('.first');
  if (!first) return;
  const related = document.querySelectorAll('.octicon-bookmark');
  if (!related) return;

  const viewRelatedButton = document.createElement('button');
  viewRelatedButton.className = 'ui button tw-mt-1';
  viewRelatedButton.style.minHeight = 'unset';
  viewRelatedButton.textContent = `Related (${related.length})`;
  viewRelatedButton.addEventListener('click', () => {
    const topRelatedElements = document.querySelectorAll('.top-related');
    const topRelatedElementsLength = topRelatedElements.length;
    for (const el of topRelatedElements) el.closest('div').classList.add('tw-hidden');

    if (topRelatedElementsLength) {
      for (const el of topRelatedElements) el.closest('div').remove();
      return;
    }

    const relatedItems = Array.from(related).reverse();
    for (const el of relatedItems) {
      const parentElement = el.closest('div').cloneNode(true);
      parentElement.classList.remove('tw-hidden');
      parentElement.classList.add('top-related');
      first.insertAdjacentElement('afterend', parentElement);
    }
  });
  first.append(viewRelatedButton);
}

function addReverseButton() {
  const first = document.querySelector('.first');
  if (!first) return;
  const timeline = document.querySelector('.timeline');
  if (!timeline) return;

  const reverseButton = document.createElement('button');
  reverseButton.className = 'ui button tw-mt-1';
  reverseButton.style.minHeight = 'unset';
  reverseButton.textContent = 'Reverse';
  reverseButton.addEventListener('click', () => {
    reverseButton.textContent = reverseButton.textContent.includes('Reverse') ? 'Obverse' : 'Reverse';
    timeline.classList.toggle('timeline-reverse');
  });
  first.append(reverseButton);
}

function copyToClipboard(text) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text);
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      // eslint-disable-next-line unicorn/prefer-dom-node-append
      document.body.appendChild(textarea);
      textarea.select();
      // eslint-disable-next-line @typescript-eslint/no-deprecated
      document.execCommand('copy');
      textarea.remove();
    }
    return true;
  } catch {}
}

function addCopyTitleButton() {
  const first = document.querySelector('.first');
  if (!first) return;
  const copyTitleButton = document.createElement('button');
  copyTitleButton.className = 'ui button tw-mt-1';
  copyTitleButton.style.minHeight = 'unset';
  copyTitleButton.textContent = 'Copy title';
  copyTitleButton.addEventListener('click', () => {
    const id = document.querySelector('.issue-content-right .octicon-copy').closest('button').dataset.clipboardText;
    let title = document.querySelector('.issue-title h1').firstChild.textContent.trim();
    if (title.endsWith(' (')) title = title.slice(0, -2);
    copyTitleButton.setCustomValidity(copyToClipboard(`- [ ] ${id}\t${title}`) ? window.config.i18n.copy_success : window.config.i18n.copy_error);
    copyTitleButton.reportValidity();
  });
  first.append(copyTitleButton);
}

function addCopyIssuesTitleButton() {
  const toolBar = document.querySelector('#issue-actions .issue-list-toolbar-right .menu');
  if (!toolBar) return;

  if (!document.querySelector('.copy-title-list')) {
    const copyTitleButton = document.createElement('button');
    copyTitleButton.className = 'ui basic button issue-action copy-title-list';
    copyTitleButton.textContent = 'Copy Titles';
    copyTitleButton.addEventListener('click', () => {
      const selectedIssuesLists = document.querySelectorAll('.issue-checkbox:checked');
      const fullTitleLists = [];
      let i = 1;
      for (const el of selectedIssuesLists) {
        const titleElement = el.closest('div.flex-item').querySelector('.flex-item-title').querySelector('a');
        const id = titleElement.getAttribute('href').slice(1).replace(/\/issues\//, '#');
        const title = titleElement.textContent.trim();
        fullTitleLists.push(`${i++}. ${id}\t${title}`);
      }

      if (fullTitleLists.length) copyToClipboard(fullTitleLists.join('\n'));
    });
    toolBar.prepend(copyTitleButton);
  }
}

function addCommitsCheckBox() {
  const wrapper = document.querySelectorAll('.message-wrapper');
  if (!wrapper) return;
  for (const el of wrapper) {
    const title = el.querySelector('.commit-summary')?.title;
    if (!title) break;
    const checkbox = document.createElement('input');
    checkbox.setAttribute('type', 'checkbox');
    checkbox.setAttribute('class', 'issue-checkbox');
    checkbox.setAttribute('value', title.replace(/(#\d+) \(#\d+\)$/, '$1'));
    checkbox.addEventListener('change', () => {
      const selectedCommits = document.querySelectorAll('.issue-checkbox:checked');
      const fullTitleLists = [];
      for (const el of selectedCommits) {
        fullTitleLists.push(`- [ ] ${el.value}`);
      }

      if (fullTitleLists.length) copyToClipboard(fullTitleLists.join('\n'));
    });
    el.prepend(checkbox);
  }
}

function addRevisionNumber() {
  const commitSummary = document.querySelector('.octicon-history');
  if (!commitSummary) return;
  const urlSearchParams = new URLSearchParams(location.search);
  let revision = commitSummary.closest('a').querySelector('b')?.textContent.replace(/,/, '') - (urlSearchParams.get('page') ? (urlSearchParams.get('page') - 1) * 50 : 0);
  const commitIDElemtns = document.querySelectorAll('.commit-id-short');
  for (const el of commitIDElemtns) {
    el.prepend(`r${revision--} `);
  }
}

function notificationToSystem() {
  const NOTIFY_INTERVAL = 300_000;
  const STORAGE_KEY = 'notificationed';

  if (!('Notification' in window)) {
    console.warn('Browser does not support notifications.');
  } else {
    (async () => {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') return;

      const channel = new BroadcastChannel('logout-notify');
      let notificationTimer = null;

      const fetchNotifications = async () => {
        try {
          const url = new URL('/api/v1/notifications', location.origin);
          url.search = new URLSearchParams({
            'status-types': 'unread',
            limit: 10,
            _csrf: window.config.csrfToken,
          });

          const response = await get(url);
          if (!response) return;

          const notificationCount = document.querySelector('.notification_count');
          if (notificationCount) {
            notificationCount.textContent = response.length;
            notificationCount.classList.remove('tw-hidden');
          }

          const lastNotified = localStorage.getItem(STORAGE_KEY);

          for (const data of Array.from(response).reverse()) {
            if (!lastNotified || data.updated_at > lastNotified) {
              localStorage.setItem(STORAGE_KEY, data.updated_at);

              const n = new Notification(
                `${data.repository.full_name}#${data.subject.html_url.split('/').pop()} ${data.subject.state}`,
                {
                  icon: `${window.config.appUrl}assets/img/favicon.png`,
                  body: data.subject.title,
                  tag: `Gitea${data.id}`,
                },
              );

              n.onclick = (e) => {
                e.preventDefault();
                window.open(
                  data.subject.latest_comment_html_url || data.subject.html_url,
                  '_blank',
                );
              };
            }
          }
        } catch (err) {
          console.error('Fetch notification failed:', err);
          clearInterval(notificationTimer);
          notificationTimer = null;
        }
      };

      const start = () => {
        channel.postMessage(null);
        if (!notificationTimer) {
          notificationTimer = setInterval(fetchNotifications, NOTIFY_INTERVAL);
        }
      };

      channel.onmessage = () => {
        clearInterval(notificationTimer);
        notificationTimer = null;
      };

      window.addEventListener('focus', start);

      start();
    })();
  }
}

function parseSizeToBytes(str) {
  const m = str.trim().match(/^([\d.]+)\s*(B|KiB|MiB|GiB|KB|MB|GB)$/i);
  if (!m) return NaN;

  const value = parseFloat(m[1]);
  const unit = m[2].toUpperCase();

  const map = {
    B: 1,
    KIB: 1024,
    MIB: 1024 ** 2,
    GIB: 1024 ** 3,
    KB: 1000,
    MB: 1000 ** 2,
    GB: 1000 ** 3,
  };

  return value * (map[unit] ?? 1);
}

function escapeRegExp(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function toYMD(d) {
  return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
}

async function autoRemoveFiles() {
  if (!Array.from(document.querySelectorAll('.list.labels-list a')).some((el) => el.textContent.toLowerCase() === 'solved')) return;

  const userComments = document.querySelectorAll(`.comment:not(.form) a[href="/${window.loginedUser}"].timeline-avatar`);
  for (const el of userComments) {
    const commentElement = el.closest('div.comment');
    const updateDataSet = commentElement.querySelector('.edit-content-zone').dataset;
    if (updateDataSet) {
      const attachmentsElements = commentElement.querySelectorAll('.dropzone-attachments');
      for (const attachEl of attachmentsElements) {
        const fileSize = parseSizeToBytes(attachEl.querySelector('.text').textContent);
        if (fileSize < 10485760) continue; // skip less than 10MB
        if (toYMD(new Date(commentElement.querySelector('relative-time').datetime)) === toYMD(new Date())) continue;
        const commentID = updateDataSet.updateUrl.split('/').pop();
        const rawContent = document.querySelector(`#issuecomment-${commentID}-raw`);
        const fileName = attachEl.querySelector('a strong').textContent;
        rawContent.textContent = rawContent.textContent.replace(new RegExp(`\\[${escapeRegExp(fileName)}\\]\\([^\\]]*\\)`), `~~Auto remove [${fileName}]~~`);
        await post(updateDataSet.updateUrl, {content: rawContent.textContent, context: updateDataSet.context, content_version: updateDataSet.contentVersion});
        attachEl.remove();
      }
    }
  }
}

function addStickyToNavBar() {
  const navBar = document.querySelector('#navbar');
  if (!navBar) return;
  navBar.classList.add('sticky');
}

function addIssuesCheckBox() {
  if (!['/issues', '/pulls'].some((path) => location.pathname === path)) return;
  const wrapper = document.querySelectorAll('.flex-item-main');

  for (const el of wrapper) {
    const index = el.querySelector('.flex-item-body a.index')?.textContent.trim();
    const title = el.querySelector('.flex-item-title a')?.textContent;
    if (!title) break;
    const checkbox = document.createElement('input');
    checkbox.setAttribute('type', 'checkbox');
    checkbox.setAttribute('class', 'tw-mr-1');
    checkbox.setAttribute('value', `${index}\t${title}`);
    checkbox.addEventListener('change', () => {
      const selectedCommits = document.querySelectorAll('.issue-checkbox:checked');
      const fullTitleLists = [];
      for (const el of selectedCommits) {
        fullTitleLists.push(`- [ ] ${el.value}`);
      }
      if (fullTitleLists.length) copyToClipboard(fullTitleLists.join('\n'));
    });
    el.querySelector('.flex-item-title a').prepend(checkbox);
  }
}

/**
 * Wait for the DOM to be ready.
 */
document.addEventListener('DOMContentLoaded', () => {
  window.userTitle = document.querySelector('.avatar').title;
  window.dept = window.userTitle.substring(0, window.userTitle.indexOf(' '));
  window.isRD = window.dept.startsWith('RD');
  window.loginedUser = document.querySelector('#navbar .user-menu .header strong')?.textContent;

  controlButtonsVisibility();
  waitForTextareaToBeReady();
  watchAnnouncementsRepos();
  addCommentCounter();
  relationPRtoIssuesTitle();
  if (location.hash === '#report') {
    reportGenerator();
  }
  if (location.pathname.includes('/releases')) {
    addReleaseFilterBar();
  }

  // addPageControlBarToTop();
  addPageControlButton();
  addViewLogsButton();
  addRelatedButton();
  addReverseButton();
  addCopyTitleButton();
  addCopyIssuesTitleButton();
  addCommitsCheckBox();
  addRevisionNumber();
  notificationToSystem();
  autoRemoveFiles();
  addStickyToNavBar();
  addIssuesCheckBox();
});
