/**
 * Scroll to top or bottom of the page.
 */
// eslint-disable-next-line @typescript-eslint/no-unused-vars
function goTo(position) {
  window.scrollTo({
    top: position === 'bottom' ? document.body.scrollHeight : 0,
    behavior: 'smooth',
  });
}

function controlButtonsVisibility() {
  if (document.body.scrollHeight <= window.innerHeight) return;
  const observer = new IntersectionObserver((entries) => {
    for (const entry of entries) {
      if (entry.target.id === 'navbar' && entry.isIntersecting) {
        document.querySelector('.gotocontrol.up').classList.add('tw-hidden');
        document.querySelector('.gotocontrol.down').classList.remove('tw-hidden');
      } else if (entry.target.id === '' && entry.isIntersecting) {
        document.querySelector('.gotocontrol.down').classList.add('tw-hidden');
        document.querySelector('.gotocontrol.up').classList.remove('tw-hidden');
      } else {
        if (window.scrollY > 0) document.querySelector('.gotocontrol.up').classList.remove('tw-hidden');
        document.querySelector('.gotocontrol.down').classList.remove('tw-hidden');
      }
    }
  }, {
    root: null,
    threshold: 0,
  });

  observer.observe(document.querySelector('#navbar'));
  observer.observe(document.querySelector('.page-footer'));
}

/**
 * Assign users to an issue.
 */
function hiToAssignee(usernames) {
  const assigneeUsers = document.querySelector('input[name="assignee_ids"]');
  if (!assigneeUsers) return;
  const assigneeElement = assigneeUsers.closest('div');
  const availableUsers = Array.from(assigneeElement.querySelectorAll('.dropdown a.item:not(.checked) span.gt-ellipsis'));
  const assigneeDropdown = assigneeElement.querySelector('.dropdown');

  let found = false;
  for (const username of usernames) {
    const items = availableUsers.filter((el) => el.textContent === username).map((el) => el.closest('a.item'));
    for (const item of items) {
      item.click();
      found = true;
    }
  }

  if (!found) return;
  assigneeDropdown.dispatchEvent(new Event('click', {bubbles: false}));
}

/**
 * Auto-save drafts for markdown editors using localStorage.
 */
function autoSaveDraft() {
  // Auto-save drafts for markdown editors
  for (const textarea of document.querySelectorAll('textarea')) {
    const editorWrapper = textarea._giteaComboMarkdownEditor;
    if (!editorWrapper) break;
    const cm = editorWrapper.textarea;
    if (!cm) break;
    const form = textarea.closest('form');
    if (!form) break;

    const storageKey = `gitea-draft-${editorWrapper.textarea.id}`;
    const draft = localStorage.getItem(storageKey);
    if (draft) cm.value = draft;

    const defaultContent = cm.value.trim();
    cm.addEventListener('mouseout', () => {
      const content = cm.value.trim();
      if (content.length && content !== defaultContent) {
        localStorage.setItem(storageKey, cm.value);
      }

      if (content.length) {
        const firstLine = content.split('\n')[0].trim();
        if (firstLine.startsWith('Hi @') && !firstLine.endsWith(',')) {
          hiToAssignee(firstLine.slice(4).split(' ').map((u) => u.trim().replace(/^@/, '')));
        }
      }
    });

    form.addEventListener('submit', () => {
      if (cm.value.trim() === defaultContent) cm.value = '';
      localStorage.setItem('last-submitted-draft', storageKey);
    });
  }

  const lastSubmittedDraft = localStorage.getItem('last-submitted-draft');
  if (lastSubmittedDraft) {
    localStorage.removeItem(lastSubmittedDraft);
    localStorage.removeItem('last-submitted-draft');
  }
}

/**
 * Automatically react with "eyes" emoji when a comment comes into view.
 * This uses IntersectionObserver to detect when comment headers are fully visible.
 * It waits 3 seconds before adding the reaction to avoid accidental reactions.
 * It also checks if the reaction already exists to prevent duplicates.
 * @see https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API
 */
function eyesHandler() {
  const commentList = document.querySelector('.comment-list');
  if (!commentList) return;
  const observer = new IntersectionObserver((entries) => {
    for (const entry of entries) {
      if (entry.isIntersecting) {
        observer.unobserve(entry.target);
        const eyes = entry.target.querySelector('a.emoji[data-tooltip-content="eyes"]');
        if (eyes) {
          const loginedUser = document.querySelector('#navbar .user-menu .header strong').textContent;
          const existEyesReaction = entry.target.querySelector(`.bottom-reactions a[data-reaction-content=eyes][title*=${loginedUser}]`);
          if (existEyesReaction?.title.split(',').map((s) => s.trim()).includes(loginedUser)) {
            return;
          }
          setTimeout(() => {
            eyes.click();
          }, 3000);
        }
      }
    }
  }, {
    root: null,
    rootMargin: '-20% 0px',
    threshold: 1,
  });

  const commentHeaders = commentList.querySelectorAll('.comment-container');
  for (const header of commentHeaders) {
    observer.observe(header);
  }
}

/**
 * Wait for the markdown editor to be ready.
 */
function waitForTextareaToBeReady() {
  let attemptCount = 0;
  const MAX_ATTEMPTS = 30;
  const INTERVAL_MS = 100;

  const intervalId = setInterval(() => {
    const markdownEditor = document.querySelector('textarea')?._giteaComboMarkdownEditor;
    attemptCount++;

    if (markdownEditor) {
      clearInterval(intervalId);
      autoSaveDraft();
      eyesHandler();
    } else if (attemptCount >= MAX_ATTEMPTS) {
      clearInterval(intervalId);
    }
  }, INTERVAL_MS);
}

function watchAnnouncementsRepos() {
  const announcementPath = '/ADM/ANN';
  const isAnnouncementPage = window.location.pathname.startsWith(announcementPath);

  if (isAnnouncementPage) {
    const unwatchFormButtonElement = document.querySelector(`form[action="${announcementPath}/action/unwatch"] button`);
    const watchFormButtonElement = document.querySelector(`form[action="${announcementPath}/action/watch"] button`);

    if (unwatchFormButtonElement) {
      unwatchFormButtonElement.disabled = true;
    }

    if (watchFormButtonElement) {
      watchFormButtonElement.click();
    }
  }
}

function addCommentCounter() {
  const commentLists = document.querySelectorAll('.comment-list .comment-header-left');
  if (!commentLists) return;

  for (const [index, commentHeader] of commentLists.entries()) {
    if (index === 0) continue; // Skip the first comment (issue description)
    const counterSpan = document.createElement('span');
    counterSpan.className = 'comment-counter';
    counterSpan.textContent = `#${index} `;
    commentHeader.prepend(counterSpan);
  }
}

function relationPRtoIssuesTitle() {
  if (!document.querySelector('.pullrequest-form')) return;
  const comparePos = location.pathname.indexOf('/compare/');
  if (comparePos === -1) return;
  const reposName = location.pathname.substring(1, comparePos);
  if (!reposName) return;
  const branchNameWithID = location.pathname.substring(location.pathname.indexOf('...') + 3, location.pathname.length).replace(/%23/g, '#');
  const branchNameAndRepoAndIDMatch = /^(\w+)_.*_([\w/-]+)[_#](\d+)$/.exec(branchNameWithID);
  const branchNameAndIDMatch = /^(\w+)_.*_#?(\d+)$/.exec(branchNameWithID);
  const issueRepoAndIDMatch = /_([\w/-]+)[_#](\d+)$/.exec(branchNameWithID);
  const issueIDOnlyMatch = /[_#](\d+)$/.exec(branchNameWithID);
  const issueTitleInput = document.querySelector('#issue_title');
  const markdownEditor = document.querySelector('.markdown-text-editor');

  const fetchIssueDetails = async (mergeReposName, mergeIssueID) => {
    // eslint-disable-next-line no-restricted-syntax
    const response = await fetch(`/api/v1/repos/${mergeReposName}/issues/${mergeIssueID}`);
    const issueData = await response.json();
    const gid = reposName === mergeReposName ? `#${mergeIssueID}` : `${mergeReposName}#${mergeIssueID}`;
    issueTitleInput.value = `${issueData.title} ${gid}`;
    markdownEditor.value = markdownEditor.value.replace(/Issue ID:/, `Issue ID: ${gid}`);
    const commitSummary = Array.from(document.querySelectorAll('.commit-summary'), (v) => v.textContent).reverse();
    markdownEditor.value = markdownEditor.value.replace(/Description:\n -/, `Description:\n- ${commitSummary.join('\n - ')}`);
  };

  function selectedBranchName(branchName) {
    const branchWithoutRepo = location.pathname.substring(location.pathname.indexOf('/compare/') + 9);
    if (!branchWithoutRepo.startsWith(branchName)) {
      const matchBranch = Array.from(document.querySelectorAll('.base-branch-list a')).find((el) => el.textContent.endsWith(branchName));
      if (matchBranch) {
        const threeDotPos = branchWithoutRepo.indexOf('...');
        location = new URL(location.href.replace(branchWithoutRepo.substring(0, threeDotPos), branchName));
      }
    }
  }

  if (branchNameAndRepoAndIDMatch?.length > 3) {
    selectedBranchName(branchNameAndRepoAndIDMatch[2]);
    fetchIssueDetails(branchNameAndRepoAndIDMatch[2], branchNameAndRepoAndIDMatch[3]);
  } else if (branchNameAndIDMatch?.length > 2) {
    selectedBranchName(branchNameAndIDMatch[1]);
    fetchIssueDetails(reposName, branchNameAndIDMatch[2]);
  } else if (issueRepoAndIDMatch?.length > 2) {
    fetchIssueDetails(issueRepoAndIDMatch[1], issueRepoAndIDMatch[2]);
  } else if (issueIDOnlyMatch?.length > 1) {
    fetchIssueDetails(reposName, issueIDOnlyMatch[1]);
  }
}

const loadResource = (url, callback) => {
  if (document.querySelector(`script[src="${url}"]`) || document.querySelector(`link[href="${url}"]`)) {
    return;
  }
  const type = url.endsWith('.css') ? 'css' : 'js';
  const element = document.createElement(type === 'css' ? 'link' : 'script');
  if (type === 'css') {
    element.rel = 'stylesheet';
    element.href = url;
  } else {
    element.src = url;
    element.defer = true;
  }

  element.addEventListener('load', () => {
    callback && callback();
  });

  if (type === 'css') {
    document.head.appendChild(element);
  } else {
    document.body.appendChild(element);
  }
};

// eslint-disable-next-line @typescript-eslint/no-unused-vars
function reportGenerator() {
  document.querySelector('.page-content').classList.add('tw-hidden');
  document.querySelector('#report').classList.remove('tw-hidden');
  loadResource('https://unpkg.com/vue@3/dist/vue.global.prod.js', () => {
    const { createApp, watch } = Vue;

    const app = createApp({
      data() {
        return {
          repos: '',
          startDate: '',
          endDate: '',
          by: 'assigned_by',
          type: 'all',
          state: 'open',
          reportData: [],
          loading: false,
        };
      },
      methods: {
        // 1
      },
    }).mount('#report');
  });
  loadResource('https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css');
  loadResource('https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js');
  loadResource('https://cdn.jsdelivr.net/npm/file-saverjs/FileSaver.min.js');
  loadResource('https://cdn.jsdelivr.net/npm/tableexport/dist/css/tableexport.min.css');
  loadResource('https://cdn.jsdelivr.net/npm/tableexport/dist/js/tableexport.min.js');
  loadResource('https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js', () => {
    const columns = [{name: "Name"}, {name: "Age"}, {name: "City"}];
    // eslint-disable-next-line no-undef
    const grid = new gridjs.Grid({
      columns,
      data: [
        ["Alice", 23, "Taipei"],
        ["Bob", 30, "Tokyo"],
        ["Charlie", 27, "Seoul"],
        ["Dylan", 31, "Osaka"],
      ],
      sort: true,
      search: true,
    }).render(document.querySelector('#wrapper'));

    for (const column of columns) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `toggle-column-${column.name}`;
      checkbox.checked = true;
      checkbox.addEventListener('change', (event) => {
        column.hidden = !event.target.checked;
        grid.updateConfig({
          columns,
        }).forceRender();
      });

      const label = document.createElement('label');
      label.htmlFor = `toggle-column-${column.name}`;
      label.textContent = column.name;

      const container = document.querySelector('#column-controls');
      container.append(checkbox);
      container.append(label);
      container.append(document.createTextNode(' '));
    }

  });


}

/**
 * Wait for the DOM to be ready.
 */
document.addEventListener('DOMContentLoaded', () => {
  controlButtonsVisibility();
  waitForTextareaToBeReady();
  watchAnnouncementsRepos();
  addCommentCounter();
  relationPRtoIssuesTitle();
  if (location.hash === '#report') {
    reportGenerator();
  }
});
